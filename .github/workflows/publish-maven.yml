name: Publish to Maven Central

on:
  workflow_dispatch:
    inputs:
      publishing_type:
        description: 'Publishing type for the deployment'
        required: true
        default: 'user_managed'
        type: choice
        options:
          - user_managed
          - automatic
      version_override:
        description: 'Version to publish (leave empty to use gradle.properties VERSION_NAME)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  publish:
    name: Publish to Maven Central Portal
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        
      - name: Configure signing
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          echo "signing.keyId=${{ secrets.SIGNING_KEY_ID }}" >> ~/.gradle/gradle.properties
          echo "signing.password=$SIGNING_PASSWORD" >> ~/.gradle/gradle.properties
          echo "signing.secretKeyRingFile=$HOME/.gnupg/secring.gpg" >> ~/.gradle/gradle.properties
          mkdir -p ~/.gnupg
          echo "$SIGNING_KEY" | base64 --decode > ~/.gnupg/secring.gpg
          
      - name: Configure Portal credentials
        env:
          CENTRAL_PORTAL_TOKEN: ${{ secrets.CENTRAL_PORTAL_TOKEN }}
          CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
        run: |
          echo "centralPortalToken=$CENTRAL_PORTAL_TOKEN" >> ~/.gradle/gradle.properties
          echo "centralPortalPassword=$CENTRAL_PORTAL_PASSWORD" >> ~/.gradle/gradle.properties
          
      - name: Override version if specified
        if: inputs.version_override != ''
        run: |
          sed -i "s/VERSION_NAME=.*/VERSION_NAME=${{ inputs.version_override }}/" gradle.properties
          echo "Updated version to: ${{ inputs.version_override }}"
          
      - name: Build artifacts
        run: |
          ./gradlew clean build
          ./gradlew androidJavadocsJar androidSourcesJar
          
      - name: Publish to Maven Central Portal
        run: ./gradlew publishRelease
        
      - name: Upload to Maven Central Portal
        env:
          CENTRAL_PORTAL_TOKEN: ${{ secrets.CENTRAL_PORTAL_TOKEN }}
          CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
        run: |
          # Get the namespace from gradle.properties
          NAMESPACE=$(grep "^GROUP=" gradle.properties | cut -d'=' -f2)
          
          # Create Bearer auth token (as per docs)
          AUTH_TOKEN=$(echo -n "$CENTRAL_PORTAL_TOKEN:$CENTRAL_PORTAL_PASSWORD" | base64)
          
          # Call the manual upload endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $AUTH_TOKEN" \
            "https://ossrh-staging-api.central.sonatype.com/manual/upload/defaultRepository/${NAMESPACE}?publishing_type=${{ inputs.publishing_type }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "Error: Portal upload failed with HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
          
          echo "Success! Deployment uploaded to Portal."
          
      - name: Summary
        run: |
          VERSION=$(grep "^VERSION_NAME=" gradle.properties | cut -d'=' -f2)
          echo "## Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Publishing Type**: ${{ inputs.publishing_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.publishing_type }}" == "user_managed" ]; then
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to [Maven Central Portal Deployments](https://central.sonatype.com/publishing/deployments)" >> $GITHUB_STEP_SUMMARY
            echo "2. Find your deployment (version $VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "3. Review and click 'Publish' to release to Maven Central" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⏱️ **Timeline**:" >> $GITHUB_STEP_SUMMARY
            echo "- Validation: 15-30 minutes" >> $GITHUB_STEP_SUMMARY
            echo "- Portal search: 1-2 hours" >> $GITHUB_STEP_SUMMARY
            echo "- Maven Central sync: 2-4 hours" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status" >> $GITHUB_STEP_SUMMARY
            echo "✅ Deployment will be automatically released if validation passes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⏱️ **Timeline**:" >> $GITHUB_STEP_SUMMARY
            echo "- Validation and release: 15-30 minutes" >> $GITHUB_STEP_SUMMARY
            echo "- Portal search: 1-2 hours" >> $GITHUB_STEP_SUMMARY
            echo "- Maven Central sync: 2-4 hours" >> $GITHUB_STEP_SUMMARY
          fi